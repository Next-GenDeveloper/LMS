import { User } from '../models/User.ts';
import { hashPassword, comparePassword } from '../utils/Passwordhash.ts';
import { generateToken } from '../utils/jwt.ts';
import * as expressValidator from 'express-validator';
const { validationResult } = expressValidator;
export const registerUser = async (req, res) => {
    try {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({ errors: errors.array() });
        }
        const { email, password, fullName, role } = req.body;
        const [firstName, ...rest] = (fullName || '').split(' ');
        const lastName = rest.join(' ') || '';
        // Prevent admin registration through normal registration
        const ADMIN_EMAIL = 'mirkashi28@gmail.com';
        if (email.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase()) {
            return res.status(403).json({ message: 'Admin account cannot be registered through this form' });
        }
        const existing = await User.findOne({ email });
        if (existing) {
            return res.status(400).json({ message: 'User already exists' });
        }
        const hashed = await hashPassword(password);
        // Always set role to 'student' - admin role cannot be assigned through registration
        const newUser = new User({ email, password: hashed, firstName, lastName, role: 'student' });
        await newUser.save();
        const token = generateToken({ userId: newUser._id.toString(), email: newUser.email, role: 'student' });
        return res.status(201).json({ token, user: { id: newUser._id, email: newUser.email, firstName: newUser.firstName, lastName: newUser.lastName } });
    }
    catch (error) {
        console.error(error);
        return res.status(500).json({ message: 'Server error' });
    }
};
export const loginUser = async (req, res) => {
    try {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({ errors: errors.array() });
        }
        const { email, password, isAdmin } = req.body;
        // Hardcoded Super Admin credentials
        const ADMIN_EMAIL = 'admin@9tangle.com';
        const ADMIN_PASSWORD = 'Admin@9tangle2025!';
        // Check for admin credentials
        const isAdminLogin = email?.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase() && password === ADMIN_PASSWORD;
        if (isAdminLogin) {
            // Find or create admin user
            let adminUser = await User.findOne({ email: ADMIN_EMAIL });
            if (!adminUser) {
                // Create admin user if doesn't exist
                const { hashPassword } = await import('../utils/Passwordhash.ts');
                const hashedPassword = await hashPassword(ADMIN_PASSWORD);
                adminUser = new User({
                    email: ADMIN_EMAIL,
                    password: hashedPassword,
                    firstName: 'Super',
                    lastName: 'Admin',
                    role: 'admin',
                    isVerified: true,
                });
                await adminUser.save();
            }
            else {
                // Ensure existing user is admin
                if (adminUser.role !== 'admin') {
                    adminUser.role = 'admin';
                    await adminUser.save();
                }
            }
            const token = generateToken({
                userId: adminUser._id.toString(),
                email: adminUser.email,
                role: 'admin'
            });
            return res.status(200).json({
                token,
                user: {
                    id: adminUser._id,
                    email: adminUser.email,
                    firstName: adminUser.firstName,
                    lastName: adminUser.lastName,
                    role: 'admin'
                }
            });
        }
        // Regular user login
        const user = await User.findOne({ email });
        if (!user) {
            return res.status(400).json({ message: 'Invalid credentials' });
        }
        const isMatch = await comparePassword(password, user.password);
        if (!isMatch) {
            return res.status(400).json({ message: 'Invalid credentials' });
        }
        const token = generateToken({ userId: user._id.toString(), email: user.email, role: user.role });
        return res.status(200).json({
            token,
            user: {
                id: user._id,
                email: user.email,
                firstName: user.firstName,
                lastName: user.lastName,
                role: user.role
            }
        });
    }
    catch (error) {
        console.error(error);
        return res.status(500).json({ message: 'Server error' });
    }
};
export const promoteUserRole = async (req, res) => {
    try {
        const { email, role, secret } = req.body || {};
        if (!email || !role)
            return res.status(400).json({ message: 'email and role are required' });
        // Basic guard to avoid accidental exposure in dev
        const DEV_SECRET = process.env.DEV_PROMOTE_SECRET || 'dev-secret';
        if (process.env.NODE_ENV !== 'development' && secret !== DEV_SECRET) {
            return res.status(403).json({ message: 'Forbidden' });
        }
        if (!['student', 'admin'].includes(role)) {
            return res.status(400).json({ message: 'Invalid role' });
        }
        const user = await User.findOneAndUpdate({ email }, { role }, { new: true });
        if (!user)
            return res.status(404).json({ message: 'User not found' });
        return res.json({ id: user._id, email: user.email, role: user.role });
    }
    catch (e) {
        console.error(e);
        return res.status(500).json({ message: 'Server error' });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aENvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29udHJvbGxlcnMvYXV0aENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2hELE9BQU8sS0FBSyxnQkFBZ0IsTUFBTSxtQkFBbUIsQ0FBQztBQUN0RCxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxnQkFBdUIsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNoRSxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7WUFDdEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNyRCxNQUFNLENBQUMsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FB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QUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDM0QsQ0FBQztRQUNELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFDdEUsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFBQyxPQUFPLENBQU0sRUFBRSxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQzNELENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9tb2RlbHMvVXNlci50cyc7XHJcbmltcG9ydCB7IGhhc2hQYXNzd29yZCwgY29tcGFyZVBhc3N3b3JkIH0gZnJvbSAnLi4vdXRpbHMvUGFzc3dvcmRoYXNoLnRzJztcclxuaW1wb3J0IHsgZ2VuZXJhdGVUb2tlbiB9IGZyb20gJy4uL3V0aWxzL2p3dC50cyc7XHJcbmltcG9ydCAqIGFzIGV4cHJlc3NWYWxpZGF0b3IgZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xyXG5jb25zdCB7IHZhbGlkYXRpb25SZXN1bHQgfSA9IGV4cHJlc3NWYWxpZGF0b3IgYXMgYW55O1xyXG5cclxuZXhwb3J0IGNvbnN0IHJlZ2lzdGVyVXNlciA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yczogZXJyb3JzLmFycmF5KCkgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIGZ1bGxOYW1lLCByb2xlIH0gPSByZXEuYm9keTtcclxuICAgIGNvbnN0IFtmaXJzdE5hbWUsIC4uLnJlc3RdID0gKGZ1bGxOYW1lIHx8ICcnKS5zcGxpdCgnICcpO1xyXG4gICAgY29uc3QgbGFzdE5hbWUgPSByZXN0LmpvaW4oJyAnKSB8fCAnJztcclxuICAgIFxyXG4gICAgLy8gUHJldmVudCBhZG1pbiByZWdpc3RyYXRpb24gdGhyb3VnaCBub3JtYWwgcmVnaXN0cmF0aW9uXHJcbiAgICBjb25zdCBBRE1JTl9FTUFJTCA9ICdtaXJrYXNoaTI4QGdtYWlsLmNvbSc7XHJcbiAgICBpZiAoZW1haWwudG9Mb3dlckNhc2UoKS50cmltKCkgPT09IEFETUlOX0VNQUlMLnRvTG93ZXJDYXNlKCkpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogJ0FkbWluIGFjY291bnQgY2Fubm90IGJlIHJlZ2lzdGVyZWQgdGhyb3VnaCB0aGlzIGZvcm0nIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsIH0pO1xyXG4gICAgaWYgKGV4aXN0aW5nKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdVc2VyIGFscmVhZHkgZXhpc3RzJyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBoYXNoZWQgPSBhd2FpdCBoYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xyXG4gICAgLy8gQWx3YXlzIHNldCByb2xlIHRvICdzdHVkZW50JyAtIGFkbWluIHJvbGUgY2Fubm90IGJlIGFzc2lnbmVkIHRocm91Z2ggcmVnaXN0cmF0aW9uXHJcbiAgICBjb25zdCBuZXdVc2VyID0gbmV3IFVzZXIoeyBlbWFpbCwgcGFzc3dvcmQ6IGhhc2hlZCwgZmlyc3ROYW1lLCBsYXN0TmFtZSwgcm9sZTogJ3N0dWRlbnQnIH0pO1xyXG4gICAgYXdhaXQgbmV3VXNlci5zYXZlKCk7XHJcblxyXG4gICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHsgdXNlcklkOiBuZXdVc2VyLl9pZC50b1N0cmluZygpLCBlbWFpbDogbmV3VXNlci5lbWFpbCwgcm9sZTogJ3N0dWRlbnQnIH0pO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMSkuanNvbih7IHRva2VuLCB1c2VyOiB7IGlkOiBuZXdVc2VyLl9pZCwgZW1haWw6IG5ld1VzZXIuZW1haWwsIGZpcnN0TmFtZTogbmV3VXNlci5maXJzdE5hbWUsIGxhc3ROYW1lOiBuZXdVc2VyLmxhc3ROYW1lIH0gfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ1NlcnZlciBlcnJvcicgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuZXhwb3J0IGNvbnN0IGxvZ2luVXNlciA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yczogZXJyb3JzLmFycmF5KCkgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIGlzQWRtaW4gfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgIC8vIEhhcmRjb2RlZCBTdXBlciBBZG1pbiBjcmVkZW50aWFsc1xyXG4gICAgY29uc3QgQURNSU5fRU1BSUwgPSAnYWRtaW5AOXRhbmdsZS5jb20nO1xyXG4gICAgY29uc3QgQURNSU5fUEFTU1dPUkQgPSAnQWRtaW5AOXRhbmdsZTIwMjUhJztcclxuXHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIGFkbWluIGNyZWRlbnRpYWxzXHJcbiAgICBjb25zdCBpc0FkbWluTG9naW4gPSBlbWFpbD8udG9Mb3dlckNhc2UoKS50cmltKCkgPT09IEFETUlOX0VNQUlMLnRvTG93ZXJDYXNlKCkgJiYgcGFzc3dvcmQgPT09IEFETUlOX1BBU1NXT1JEO1xyXG5cclxuXHJcbiAgICBpZiAoaXNBZG1pbkxvZ2luKSB7XHJcbiAgICAgIC8vIEZpbmQgb3IgY3JlYXRlIGFkbWluIHVzZXJcclxuICAgICAgbGV0IGFkbWluVXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiBBRE1JTl9FTUFJTCB9KTtcclxuXHJcbiAgICAgIGlmICghYWRtaW5Vc2VyKSB7XHJcbiAgICAgICAgLy8gQ3JlYXRlIGFkbWluIHVzZXIgaWYgZG9lc24ndCBleGlzdFxyXG4gICAgICAgIGNvbnN0IHsgaGFzaFBhc3N3b3JkIH0gPSBhd2FpdCBpbXBvcnQoJy4uL3V0aWxzL1Bhc3N3b3JkaGFzaC50cycpO1xyXG4gICAgICAgIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgaGFzaFBhc3N3b3JkKEFETUlOX1BBU1NXT1JEKTtcclxuICAgICAgICBhZG1pblVzZXIgPSBuZXcgVXNlcih7XHJcbiAgICAgICAgICBlbWFpbDogQURNSU5fRU1BSUwsXHJcbiAgICAgICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXHJcbiAgICAgICAgICBmaXJzdE5hbWU6ICdTdXBlcicsXHJcbiAgICAgICAgICBsYXN0TmFtZTogJ0FkbWluJyxcclxuICAgICAgICAgIHJvbGU6ICdhZG1pbicsXHJcbiAgICAgICAgICBpc1ZlcmlmaWVkOiB0cnVlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGF3YWl0IGFkbWluVXNlci5zYXZlKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRW5zdXJlIGV4aXN0aW5nIHVzZXIgaXMgYWRtaW5cclxuICAgICAgICBpZiAoYWRtaW5Vc2VyLnJvbGUgIT09ICdhZG1pbicpIHtcclxuICAgICAgICAgIGFkbWluVXNlci5yb2xlID0gJ2FkbWluJztcclxuICAgICAgICAgIGF3YWl0IGFkbWluVXNlci5zYXZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlVG9rZW4oe1xyXG4gICAgICAgIHVzZXJJZDogYWRtaW5Vc2VyLl9pZC50b1N0cmluZygpLFxyXG4gICAgICAgIGVtYWlsOiBhZG1pblVzZXIuZW1haWwsXHJcbiAgICAgICAgcm9sZTogJ2FkbWluJ1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgdG9rZW4sXHJcbiAgICAgICAgdXNlcjoge1xyXG4gICAgICAgICAgaWQ6IGFkbWluVXNlci5faWQsXHJcbiAgICAgICAgICBlbWFpbDogYWRtaW5Vc2VyLmVtYWlsLFxyXG4gICAgICAgICAgZmlyc3ROYW1lOiBhZG1pblVzZXIuZmlyc3ROYW1lLFxyXG4gICAgICAgICAgbGFzdE5hbWU6IGFkbWluVXNlci5sYXN0TmFtZSxcclxuICAgICAgICAgIHJvbGU6ICdhZG1pbidcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBSZWd1bGFyIHVzZXIgbG9naW5cclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyBlbWFpbCB9KTtcclxuICAgIGlmICghdXNlcikge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAnSW52YWxpZCBjcmVkZW50aWFscycgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaXNNYXRjaCA9IGF3YWl0IGNvbXBhcmVQYXNzd29yZChwYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XHJcbiAgICBpZiAoIWlzTWF0Y2gpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih7IHVzZXJJZDogdXNlci5faWQudG9TdHJpbmcoKSwgZW1haWw6IHVzZXIuZW1haWwsIHJvbGU6IHVzZXIucm9sZSB9KTtcclxuXHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICB0b2tlbixcclxuICAgICAgdXNlcjoge1xyXG4gICAgICAgIGlkOiB1c2VyLl9pZCxcclxuICAgICAgICBlbWFpbDogdXNlci5lbWFpbCxcclxuICAgICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxyXG4gICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxyXG4gICAgICAgIHJvbGU6IHVzZXIucm9sZVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnU2VydmVyIGVycm9yJyB9KTtcclxuICB9XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgcHJvbW90ZVVzZXJSb2xlID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGVtYWlsLCByb2xlLCBzZWNyZXQgfSA9IHJlcS5ib2R5IHx8IHt9O1xyXG4gICAgaWYgKCFlbWFpbCB8fCAhcm9sZSkgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ2VtYWlsIGFuZCByb2xlIGFyZSByZXF1aXJlZCcgfSk7XHJcbiAgICAvLyBCYXNpYyBndWFyZCB0byBhdm9pZCBhY2NpZGVudGFsIGV4cG9zdXJlIGluIGRldlxyXG4gICAgY29uc3QgREVWX1NFQ1JFVCA9IHByb2Nlc3MuZW52LkRFVl9QUk9NT1RFX1NFQ1JFVCB8fCAnZGV2LXNlY3JldCc7XHJcbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdkZXZlbG9wbWVudCcgJiYgc2VjcmV0ICE9PSBERVZfU0VDUkVUKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IG1lc3NhZ2U6ICdGb3JiaWRkZW4nIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCFbJ3N0dWRlbnQnLCdhZG1pbiddLmluY2x1ZGVzKHJvbGUpKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdJbnZhbGlkIHJvbGUnIH0pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZUFuZFVwZGF0ZSh7IGVtYWlsIH0sIHsgcm9sZSB9LCB7IG5ldzogdHJ1ZSB9KTtcclxuICAgIGlmICghdXNlcikgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJyB9KTtcclxuICAgIHJldHVybiByZXMuanNvbih7IGlkOiB1c2VyLl9pZCwgZW1haWw6IHVzZXIuZW1haWwsIHJvbGU6IHVzZXIucm9sZSB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnU2VydmVyIGVycm9yJyB9KTtcclxuICB9XHJcbn07XHJcbiJdfQ==