import { Router } from 'express';
import { Course } from '../models/Course.ts';
import { requireAuth, requireRole } from '../middleware/auth.ts';
const router = Router();
// List courses
router.get('/', async (_req, res) => {
    try {
        const courses = await Course.find({}).sort({ createdAt: -1 }).limit(200);
        res.json(courses.map((c) => ({
            id: c._id,
            title: c.title,
            description: c.description,
            price: c.price,
            bannerImage: c.bannerImage,
            category: c.category,
            isPublished: c.isPublished,
            createdAt: c.createdAt,
            updatedAt: c.updatedAt,
        })));
    }
    catch (e) {
        // Return a mock dataset so the UI remains usable, regardless of env
        console.warn('Course list failed, returning mock data:', e?.message || e);
        return res.json([
            {
                id: 'demo-1',
                title: 'Intro to React',
                description: 'Build interactive UIs with modern React and hooks.',
                price: 1499,
                thumbnail: '/next.svg',
                category: 'Web Development',
                isPublished: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            },
            {
                id: 'demo-2',
                title: 'TypeScript Mastery',
                description: 'Type-safe apps with generics, utility types and best practices.',
                price: 1999,
                thumbnail: '/vercel.svg',
                category: 'Programming Languages',
                isPublished: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            },
            {
                id: 'demo-3',
                title: 'Node.js APIs',
                description: 'Build secure and scalable APIs using Express and Mongoose.',
                price: 2499,
                thumbnail: '/globe.svg',
                category: 'Backend',
                isPublished: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            },
        ]);
    }
});
// Get one course
router.get('/:id', async (req, res) => {
    try {
        const id = req.params.id;
        const c = await Course.findById(id);
        if (!c)
            return res.status(404).json({ message: 'Course not found' });
        res.json({
            id: c._id,
            title: c.title,
            description: c.description,
            price: c.price,
            bannerImage: c.bannerImage,
            category: c.category,
            level: c.level,
            duration: c.duration,
            language: c.language,
            tags: c.tags,
            rating: c.rating,
            reviews: c.reviews,
            enrollmentCount: c.enrollmentCount,
            pdfFiles: c.pdfFiles || [],
            videoFiles: c.videoFiles || [],
            modules: c.modules.map(m => ({
                title: m.title,
                description: m.description,
                lessons: m.lessons.map(l => ({
                    title: l.title,
                    description: l.description,
                    videoUrl: l.videoUrl,
                    duration: l.duration,
                    materials: l.materials || []
                }))
            })),
            isPublished: c.isPublished,
            createdAt: c.createdAt,
            updatedAt: c.updatedAt,
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to get course' });
    }
});
// Get course details with full information (for course page)
router.get('/:id/details', async (req, res) => {
    try {
        const id = req.params.id;
        const c = await Course.findById(id);
        if (!c)
            return res.status(404).json({ message: 'Course not found' });
        // Calculate total lessons and duration
        let totalLessons = 0;
        let totalDuration = 0;
        c.modules.forEach(module => {
            module.lessons.forEach(lesson => {
                totalLessons++;
                totalDuration += lesson.duration;
            });
        });
        res.json({
            id: c._id,
            title: c.title,
            description: c.description,
            bannerImage: c.bannerImage,
            price: c.price,
            originalPrice: c.price * 2, // Simple way to show discount
            rating: c.rating,
            reviews: c.reviews,
            students: c.enrollmentCount,
            duration: `${c.duration} hours`,
            lessons: totalLessons,
            level: c.level,
            language: c.language,
            lastUpdated: c.updatedAt.toISOString().split('T')[0],
            certificate: true,
            whatYouLearn: [
                `Master ${c.category} from scratch`,
                `Build real-world ${c.category} projects`,
                `Understand ${c.category} best practices`,
                `Learn from industry experts`,
                `Get hands-on experience with ${c.category}`
            ],
            requirements: [
                `Basic knowledge of ${c.language || 'programming'}`,
                `A computer with internet access`,
                `Willingness to learn and practice`
            ],
            curriculum: c.modules.map(m => ({
                title: m.title,
                lessons: m.lessons.map(l => ({
                    title: l.title,
                    duration: `${l.duration} minutes`,
                    preview: false // In real implementation, this would be a field in the lesson
                }))
            })),
            instructor: {
                name: "Expert Instructor",
                avatar: "EI",
                bio: `Experienced ${c.category} instructor with years of industry experience`,
                courses: 10,
                students: 5000,
                rating: 4.8
            }
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to get course details' });
    }
});
// Create course (admin only)
router.post('/', requireAuth, requireRole('admin'), async (req, res) => {
    try {
        const { title, description, price, bannerImage, pdfFiles, videoFiles, category, level, duration, language, tags } = req.body || {};
        if (!title || !description)
            return res.status(400).json({ message: 'title and description are required' });
        const instructor = req.user?.userId;
        const course = await Course.create({
            title,
            description,
            price: Number(price) || 0,
            bannerImage: bannerImage || '',
            pdfFiles: pdfFiles || [],
            videoFiles: videoFiles || [],
            category: category || 'General',
            level: level || 'beginner',
            duration: Number(duration) || 0,
            language: language || 'English',
            tags: tags || [],
            isPublished: true,
        });
        res.status(201).json({ id: course._id });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to create course' });
    }
});
// Update course (admin only)
router.put('/:id', requireAuth, requireRole('admin'), async (req, res) => {
    try {
        const id = req.params.id;
        const payload = req.body || {};
        const updated = await Course.findByIdAndUpdate(id, payload, { new: true });
        if (!updated)
            return res.status(404).json({ message: 'Course not found' });
        res.json({ id: updated._id });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to update course' });
    }
});
// Delete course (admin only)
router.delete('/:id', requireAuth, requireRole('admin'), async (req, res) => {
    try {
        const id = req.params.id;
        const deleted = await Course.findByIdAndDelete(id);
        if (!deleted)
            return res.status(404).json({ message: 'Course not found' });
        res.json({ success: true });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to delete course' });
    }
});
export default router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291cnNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yb3V0ZXMvY291cnNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWpDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pFLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBRXhCLGVBQWU7QUFDZixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBYSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3JELElBQUksQ0FBQztRQUNILE1BQU0sT0FBTyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6RSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDM0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHO1lBQ1QsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLO1lBQ2QsV0FBVyxFQUFFLENBQUMsQ0FBQyxXQUFXO1lBQzFCLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSztZQUNkLFdBQVcsRUFBRSxDQUFDLENBQUMsV0FBVztZQUMxQixRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVE7WUFDcEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxXQUFXO1lBQzFCLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUztZQUN0QixTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVM7U0FDdkIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJ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QUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLHlCQUF5QixFQUFFLENBQUMsQ0FBQztJQUM1RSxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCw2QkFBNkI7QUFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQzdGLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ3pCLE1BQU0sT0FBTyxHQUFHLE1BQU0sTUFBTSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxDQUFDLENBQUM7UUFDM0UsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFBQyxPQUFPLENBQU0sRUFBRSxDQUFDO1FBQ2hCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUkseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB0eXBlIHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgQ291cnNlIH0gZnJvbSAnLi4vbW9kZWxzL0NvdXJzZS50cyc7XHJcbmltcG9ydCB7IHJlcXVpcmVBdXRoLCByZXF1aXJlUm9sZSB9IGZyb20gJy4uL21pZGRsZXdhcmUvYXV0aC50cyc7XHJcbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xyXG5cclxuLy8gTGlzdCBjb3Vyc2VzXHJcbnJvdXRlci5nZXQoJy8nLCBhc3luYyAoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb3Vyc2VzID0gYXdhaXQgQ291cnNlLmZpbmQoe30pLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pLmxpbWl0KDIwMCk7XHJcbiAgICByZXMuanNvbihjb3Vyc2VzLm1hcCgoYykgPT4gKHtcclxuICAgICAgaWQ6IGMuX2lkLFxyXG4gICAgICB0aXRsZTogYy50aXRsZSxcclxuICAgICAgZGVzY3JpcHRpb246IGMuZGVzY3JpcHRpb24sXHJcbiAgICAgIHByaWNlOiBjLnByaWNlLFxyXG4gICAgICBiYW5uZXJJbWFnZTogYy5iYW5uZXJJbWFnZSxcclxuICAgICAgY2F0ZWdvcnk6IGMuY2F0ZWdvcnksXHJcbiAgICAgIGlzUHVibGlzaGVkOiBjLmlzUHVibGlzaGVkLFxyXG4gICAgICBjcmVhdGVkQXQ6IGMuY3JlYXRlZEF0LFxyXG4gICAgICB1cGRhdGVkQXQ6IGMudXBkYXRlZEF0LFxyXG4gICAgfSkpKTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIC8vIFJldHVybiBhIG1vY2sgZGF0YXNldCBzbyB0aGUgVUkgcmVtYWlucyB1c2FibGUsIHJlZ2FyZGxlc3Mgb2YgZW52XHJcbiAgICBjb25zb2xlLndhcm4oJ0NvdXJzZSBsaXN0IGZhaWxlZCwgcmV0dXJuaW5nIG1vY2sgZGF0YTonLCBlPy5tZXNzYWdlIHx8IGUpO1xyXG4gICAgcmV0dXJuIHJlcy5qc29uKFtcclxuICAgICAge1xyXG4gICAgICAgIGlkOiAnZGVtby0xJyxcclxuICAgICAgICB0aXRsZTogJ0ludHJvIHRvIFJlYWN0JyxcclxuICAgICAgICBkZXNjcmlwdGlvbjogJ0J1aWxkIGludGVyYWN0aXZlIFVJcyB3aXRoIG1vZGVybiBSZWFjdCBhbmQgaG9va3MuJyxcclxuICAgICAgICBwcmljZTogMTQ5OSxcclxuICAgICAgICB0aHVtYm5haWw6ICcvbmV4dC5zdmcnLFxyXG4gICAgICAgIGNhdGVnb3J5OiAnV2ViIERldmVsb3BtZW50JyxcclxuICAgICAgICBpc1B1Ymxpc2hlZDogdHJ1ZSxcclxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgfSxcclxuICAgICAge1xyXG4gICAgICAgIGlkOiAnZGVtby0yJyxcclxuICAgICAgICB0aXRsZTogJ1R5cGVTY3JpcHQgTWFzdGVyeScsXHJcbiAgICAgICAgZGVzY3JpcHRpb246ICdUeXBlLXNhZmUgYXBwcyB3aXRoIGdlbmVyaWNzLCB1dGlsaXR5IHR5cGVzIGFuZCBiZXN0IHByYWN0aWNlcy4nLFxyXG4gICAgICAgIHByaWNlOiAxOTk5LFxyXG4gICAgICAgIHRodW1ibmFpbDogJy92ZXJjZWwuc3ZnJyxcclxuICAgICAgICBjYXRlZ29yeTogJ1Byb2dyYW1taW5nIExhbmd1YWdlcycsXHJcbiAgICAgICAgaXNQdWJsaXNoZWQ6IHRydWUsXHJcbiAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBpZDogJ2RlbW8tMycsXHJcbiAgICAgICAgdGl0bGU6ICdOb2RlLmpzIEFQSXMnLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnQnVpbGQgc2VjdXJlIGFuZCBzY2FsYWJsZSBBUElzIHVzaW5nIEV4cHJlc3MgYW5kIE1vbmdvb3NlLicsXHJcbiAgICAgICAgcHJpY2U6IDI0OTksXHJcbiAgICAgICAgdGh1bWJuYWlsOiAnL2dsb2JlLnN2ZycsXHJcbiAgICAgICAgY2F0ZWdvcnk6ICdCYWNrZW5kJyxcclxuICAgICAgICBpc1B1Ymxpc2hlZDogdHJ1ZSxcclxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgfSxcclxuICAgIF0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBHZXQgb25lIGNvdXJzZVxyXG5yb3V0ZXIuZ2V0KCcvOmlkJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBpZCA9IHJlcS5wYXJhbXMuaWQ7XHJcbiAgICBjb25zdCBjID0gYXdhaXQgQ291cnNlLmZpbmRCeUlkKGlkKTtcclxuICAgIGlmICghYykgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0NvdXJzZSBub3QgZm91bmQnIH0pO1xyXG4gICAgcmVzLmpzb24oe1xyXG4gICAgICBpZDogYy5faWQsXHJcbiAgICAgIHRpdGxlOiBjLnRpdGxlLFxyXG4gICAgICBkZXNjcmlwdGlvbjogYy5kZXNjcmlwdGlvbixcclxuICAgICAgcHJpY2U6IGMucHJpY2UsXHJcbiAgICAgIGJhbm5lckltYWdlOiBjLmJhbm5lckltYWdlLFxyXG4gICAgICBjYXRlZ29yeTogYy5jYXRlZ29yeSxcclxuICAgICAgbGV2ZWw6IGMubGV2ZWwsXHJcbiAgICAgIGR1cmF0aW9uOiBjLmR1cmF0aW9uLFxyXG4gICAgICBsYW5ndWFnZTogYy5sYW5ndWFnZSxcclxuICAgICAgdGFnczogYy50YWdzLFxyXG4gICAgICByYXRpbmc6IGMucmF0aW5nLFxyXG4gICAgICByZXZpZXdzOiBjLnJldmlld3MsXHJcbiAgICAgIGVucm9sbG1lbnRDb3VudDogYy5lbnJvbGxtZW50Q291bnQsXHJcbiAgICAgIHBkZkZpbGVzOiBjLnBkZkZpbGVzIHx8IFtdLFxyXG4gICAgICB2aWRlb0ZpbGVzOiBjLnZpZGVvRmlsZXMgfHwgW10sXHJcbiAgICAgIG1vZHVsZXM6IGMubW9kdWxlcy5tYXAobSA9PiAoe1xyXG4gICAgICAgIHRpdGxlOiBtLnRpdGxlLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiBtLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgIGxlc3NvbnM6IG0ubGVzc29ucy5tYXAobCA9PiAoe1xyXG4gICAgICAgICAgdGl0bGU6IGwudGl0bGUsXHJcbiAgICAgICAgICBkZXNjcmlwdGlvbjogbC5kZXNjcmlwdGlvbixcclxuICAgICAgICAgIHZpZGVvVXJsOiBsLnZpZGVvVXJsLFxyXG4gICAgICAgICAgZHVyYXRpb246IGwuZHVyYXRpb24sXHJcbiAgICAgICAgICBtYXRlcmlhbHM6IGwubWF0ZXJpYWxzIHx8IFtdXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pKSxcclxuICAgICAgaXNQdWJsaXNoZWQ6IGMuaXNQdWJsaXNoZWQsXHJcbiAgICAgIGNyZWF0ZWRBdDogYy5jcmVhdGVkQXQsXHJcbiAgICAgIHVwZGF0ZWRBdDogYy51cGRhdGVkQXQsXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gZ2V0IGNvdXJzZScgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbi8vIEdldCBjb3Vyc2UgZGV0YWlscyB3aXRoIGZ1bGwgaW5mb3JtYXRpb24gKGZvciBjb3Vyc2UgcGFnZSlcclxucm91dGVyLmdldCgnLzppZC9kZXRhaWxzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBpZCA9IHJlcS5wYXJhbXMuaWQ7XHJcbiAgICBjb25zdCBjID0gYXdhaXQgQ291cnNlLmZpbmRCeUlkKGlkKTtcclxuICAgIGlmICghYykgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0NvdXJzZSBub3QgZm91bmQnIH0pO1xyXG5cclxuICAgIC8vIENhbGN1bGF0ZSB0b3RhbCBsZXNzb25zIGFuZCBkdXJhdGlvblxyXG4gICAgbGV0IHRvdGFsTGVzc29ucyA9IDA7XHJcbiAgICBsZXQgdG90YWxEdXJhdGlvbiA9IDA7XHJcbiAgICBjLm1vZHVsZXMuZm9yRWFjaChtb2R1bGUgPT4ge1xyXG4gICAgICBtb2R1bGUubGVzc29ucy5mb3JFYWNoKGxlc3NvbiA9PiB7XHJcbiAgICAgICAgdG90YWxMZXNzb25zKys7XHJcbiAgICAgICAgdG90YWxEdXJhdGlvbiArPSBsZXNzb24uZHVyYXRpb247XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmVzLmpzb24oe1xyXG4gICAgICBpZDogYy5faWQsXHJcbiAgICAgIHRpdGxlOiBjLnRpdGxlLFxyXG4gICAgICBkZXNjcmlwdGlvbjogYy5kZXNjcmlwdGlvbixcclxuICAgICAgYmFubmVySW1hZ2U6IGMuYmFubmVySW1hZ2UsXHJcbiAgICAgIHByaWNlOiBjLnByaWNlLFxyXG4gICAgICBvcmlnaW5hbFByaWNlOiBjLnByaWNlICogMiwgLy8gU2ltcGxlIHdheSB0byBzaG93IGRpc2NvdW50XHJcbiAgICAgIHJhdGluZzogYy5yYXRpbmcsXHJcbiAgICAgIHJldmlld3M6IGMucmV2aWV3cyxcclxuICAgICAgc3R1ZGVudHM6IGMuZW5yb2xsbWVudENvdW50LFxyXG4gICAgICBkdXJhdGlvbjogYCR7Yy5kdXJhdGlvbn0gaG91cnNgLFxyXG4gICAgICBsZXNzb25zOiB0b3RhbExlc3NvbnMsXHJcbiAgICAgIGxldmVsOiBjLmxldmVsLFxyXG4gICAgICBsYW5ndWFnZTogYy5sYW5ndWFnZSxcclxuICAgICAgbGFzdFVwZGF0ZWQ6IGMudXBkYXRlZEF0LnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcclxuICAgICAgY2VydGlmaWNhdGU6IHRydWUsXHJcbiAgICAgIHdoYXRZb3VMZWFybjogW1xyXG4gICAgICAgIGBNYXN0ZXIgJHtjLmNhdGVnb3J5fSBmcm9tIHNjcmF0Y2hgLFxyXG4gICAgICAgIGBCdWlsZCByZWFsLXdvcmxkICR7Yy5jYXRlZ29yeX0gcHJvamVjdHNgLFxyXG4gICAgICAgIGBVbmRlcnN0YW5kICR7Yy5jYXRlZ29yeX0gYmVzdCBwcmFjdGljZXNgLFxyXG4gICAgICAgIGBMZWFybiBmcm9tIGluZHVzdHJ5IGV4cGVydHNgLFxyXG4gICAgICAgIGBHZXQgaGFuZHMtb24gZXhwZXJpZW5jZSB3aXRoICR7Yy5jYXRlZ29yeX1gXHJcbiAgICAgIF0sXHJcbiAgICAgIHJlcXVpcmVtZW50czogW1xyXG4gICAgICAgIGBCYXNpYyBrbm93bGVkZ2Ugb2YgJHtjLmxhbmd1YWdlIHx8ICdwcm9ncmFtbWluZyd9YCxcclxuICAgICAgICBgQSBjb21wdXRlciB3aXRoIGludGVybmV0IGFjY2Vzc2AsXHJcbiAgICAgICAgYFdpbGxpbmduZXNzIHRvIGxlYXJuIGFuZCBwcmFjdGljZWBcclxuICAgICAgXSxcclxuICAgICAgY3VycmljdWx1bTogYy5tb2R1bGVzLm1hcChtID0+ICh7XHJcbiAgICAgICAgdGl0bGU6IG0udGl0bGUsXHJcbiAgICAgICAgbGVzc29uczogbS5sZXNzb25zLm1hcChsID0+ICh7XHJcbiAgICAgICAgICB0aXRsZTogbC50aXRsZSxcclxuICAgICAgICAgIGR1cmF0aW9uOiBgJHtsLmR1cmF0aW9ufSBtaW51dGVzYCxcclxuICAgICAgICAgIHByZXZpZXc6IGZhbHNlIC8vIEluIHJlYWwgaW1wbGVtZW50YXRpb24sIHRoaXMgd291bGQgYmUgYSBmaWVsZCBpbiB0aGUgbGVzc29uXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pKSxcclxuICAgICAgaW5zdHJ1Y3Rvcjoge1xyXG4gICAgICAgIG5hbWU6IFwiRXhwZXJ0IEluc3RydWN0b3JcIixcclxuICAgICAgICBhdmF0YXI6IFwiRUlcIixcclxuICAgICAgICBiaW86IGBFeHBlcmllbmNlZCAke2MuY2F0ZWdvcnl9IGluc3RydWN0b3Igd2l0aCB5ZWFycyBvZiBpbmR1c3RyeSBleHBlcmllbmNlYCxcclxuICAgICAgICBjb3Vyc2VzOiAxMCxcclxuICAgICAgICBzdHVkZW50czogNTAwMCxcclxuICAgICAgICByYXRpbmc6IDQuOFxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gZ2V0IGNvdXJzZSBkZXRhaWxzJyB9KTtcclxuICB9XHJcbn0pO1xyXG5cclxuLy8gQ3JlYXRlIGNvdXJzZSAoYWRtaW4gb25seSlcclxucm91dGVyLnBvc3QoJy8nLCByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUoJ2FkbWluJyksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyB0aXRsZSwgZGVzY3JpcHRpb24sIHByaWNlLCBiYW5uZXJJbWFnZSwgcGRmRmlsZXMsIHZpZGVvRmlsZXMsIGNhdGVnb3J5LCBsZXZlbCwgZHVyYXRpb24sIGxhbmd1YWdlLCB0YWdzIH0gPSByZXEuYm9keSB8fCB7fTtcclxuICAgIGlmICghdGl0bGUgfHwgIWRlc2NyaXB0aW9uKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAndGl0bGUgYW5kIGRlc2NyaXB0aW9uIGFyZSByZXF1aXJlZCcgfSk7XHJcbiAgICBjb25zdCBpbnN0cnVjdG9yID0gKHJlcSBhcyBhbnkpLnVzZXI/LnVzZXJJZDtcclxuICAgIGNvbnN0IGNvdXJzZSA9IGF3YWl0IENvdXJzZS5jcmVhdGUoe1xyXG4gICAgICB0aXRsZSxcclxuICAgICAgZGVzY3JpcHRpb24sXHJcbiAgICAgIHByaWNlOiBOdW1iZXIocHJpY2UpIHx8IDAsXHJcbiAgICAgIGJhbm5lckltYWdlOiBiYW5uZXJJbWFnZSB8fCAnJyxcclxuICAgICAgcGRmRmlsZXM6IHBkZkZpbGVzIHx8IFtdLFxyXG4gICAgICB2aWRlb0ZpbGVzOiB2aWRlb0ZpbGVzIHx8IFtdLFxyXG4gICAgICBjYXRlZ29yeTogY2F0ZWdvcnkgfHwgJ0dlbmVyYWwnLFxyXG4gICAgICBsZXZlbDogbGV2ZWwgfHwgJ2JlZ2lubmVyJyxcclxuICAgICAgZHVyYXRpb246IE51bWJlcihkdXJhdGlvbikgfHwgMCxcclxuICAgICAgbGFuZ3VhZ2U6IGxhbmd1YWdlIHx8ICdFbmdsaXNoJyxcclxuICAgICAgdGFnczogdGFncyB8fCBbXSxcclxuICAgICAgaXNQdWJsaXNoZWQ6IHRydWUsXHJcbiAgICB9KTtcclxuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHsgaWQ6IGNvdXJzZS5faWQgfSk7XHJcbiAgfSBjYXRjaCAoZTogYW55KSB7XHJcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IGUubWVzc2FnZSB8fCAnRmFpbGVkIHRvIGNyZWF0ZSBjb3Vyc2UnIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBVcGRhdGUgY291cnNlIChhZG1pbiBvbmx5KVxyXG5yb3V0ZXIucHV0KCcvOmlkJywgcmVxdWlyZUF1dGgsIHJlcXVpcmVSb2xlKCdhZG1pbicpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGlkID0gcmVxLnBhcmFtcy5pZDtcclxuICAgIGNvbnN0IHBheWxvYWQgPSByZXEuYm9keSB8fCB7fTtcclxuICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCBDb3Vyc2UuZmluZEJ5SWRBbmRVcGRhdGUoaWQsIHBheWxvYWQsIHsgbmV3OiB0cnVlIH0pO1xyXG4gICAgaWYgKCF1cGRhdGVkKSByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnQ291cnNlIG5vdCBmb3VuZCcgfSk7XHJcbiAgICByZXMuanNvbih7IGlkOiB1cGRhdGVkLl9pZCB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gdXBkYXRlIGNvdXJzZScgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbi8vIERlbGV0ZSBjb3Vyc2UgKGFkbWluIG9ubHkpXHJcbnJvdXRlci5kZWxldGUoJy86aWQnLCByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUoJ2FkbWluJyksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgaWQgPSByZXEucGFyYW1zLmlkO1xyXG4gICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IENvdXJzZS5maW5kQnlJZEFuZERlbGV0ZShpZCk7XHJcbiAgICBpZiAoIWRlbGV0ZWQpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdDb3Vyc2Ugbm90IGZvdW5kJyB9KTtcclxuICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gZGVsZXRlIGNvdXJzZScgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcclxuIl19