import { Router } from 'express';
import { Enrollment } from '../models/Enrollment.ts';
import { Course } from '../models/Course.ts';
import { requireAuth } from '../middleware/auth.ts';
const router = Router();
// Check if user is enrolled in a course
router.get('/check/:courseId', requireAuth, async (req, res) => {
    try {
        const courseId = req.params.courseId;
        const userId = req.user?.userId;
        const enrollment = await Enrollment.findOne({
            student: userId,
            course: courseId,
            paymentStatus: 'completed'
        });
        res.json({
            isEnrolled: !!enrollment,
            enrollmentStatus: enrollment?.status || null,
            paymentStatus: enrollment?.paymentStatus || null
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to check enrollment' });
    }
});
// Create enrollment with payment (simplified payment processing)
router.post('/', requireAuth, async (req, res) => {
    try {
        const { courseId, paymentMethod = 'credit_card' } = req.body;
        const userId = req.user?.userId;
        // Check if course exists
        const course = await Course.findById(courseId);
        if (!course) {
            return res.status(404).json({ message: 'Course not found' });
        }
        // Check if user is already enrolled
        const existingEnrollment = await Enrollment.findOne({
            student: userId,
            course: courseId
        });
        if (existingEnrollment) {
            if (existingEnrollment.paymentStatus === 'completed') {
                return res.status(400).json({ message: 'Already enrolled in this course' });
            }
            else {
                // Update existing enrollment
                existingEnrollment.paymentStatus = 'completed';
                existingEnrollment.status = 'active';
                existingEnrollment.paymentId = `PAY-${Date.now()}`;
                await existingEnrollment.save();
                // Update course enrollment count
                course.enrollmentCount += 1;
                await course.save();
                return res.json({
                    success: true,
                    enrollmentId: existingEnrollment._id,
                    message: 'Enrollment updated successfully'
                });
            }
        }
        // Process payment (simplified - in real app, integrate with Stripe/PayPal)
        const paymentId = `PAY-${Date.now()}`;
        const paymentStatus = 'completed'; // Assume payment succeeds
        // Create new enrollment
        const enrollment = await Enrollment.create({
            student: userId,
            course: courseId,
            status: 'active',
            paymentStatus: paymentStatus,
            paymentId: paymentId,
            progress: 0
        });
        // Update course enrollment count
        course.enrollmentCount += 1;
        await course.save();
        res.status(201).json({
            success: true,
            enrollmentId: enrollment._id,
            message: 'Enrollment successful'
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to create enrollment' });
    }
});
// Get user enrollments
router.get('/', requireAuth, async (req, res) => {
    try {
        const userId = req.user?.userId;
        const enrollments = await Enrollment.find({ student: userId })
            .populate('course', 'title description bannerImage price category')
            .sort({ enrollmentDate: -1 });
        res.json(enrollments.map(e => ({
            id: e._id,
            course: {
                id: e.course._id,
                title: e.course.title,
                description: e.course.description,
                bannerImage: e.course.bannerImage,
                price: e.course.price,
                category: e.course.category
            },
            status: e.status,
            paymentStatus: e.paymentStatus,
            progress: e.progress,
            enrollmentDate: e.enrollmentDate
        })));
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to get enrollments' });
    }
});
// Get enrollment by ID
router.get('/:id', requireAuth, async (req, res) => {
    try {
        const enrollmentId = req.params.id;
        const userId = req.user?.userId;
        const enrollment = await Enrollment.findOne({
            _id: enrollmentId,
            student: userId
        }).populate('course', 'title description bannerImage price category');
        if (!enrollment) {
            return res.status(404).json({ message: 'Enrollment not found' });
        }
        res.json({
            id: enrollment._id,
            course: {
                id: enrollment.course._id,
                title: enrollment.course.title,
                description: enrollment.course.description,
                bannerImage: enrollment.course.bannerImage,
                price: enrollment.course.price,
                category: enrollment.course.category
            },
            status: enrollment.status,
            paymentStatus: enrollment.paymentStatus,
            progress: enrollment.progress,
            enrollmentDate: enrollment.enrollmentDate
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to get enrollment' });
    }
});
// Update enrollment progress
router.put('/:id/progress', requireAuth, async (req, res) => {
    try {
        const enrollmentId = req.params.id;
        const { progress } = req.body;
        const userId = req.user?.userId;
        const enrollment = await Enrollment.findOneAndUpdate({
            _id: enrollmentId,
            student: userId
        }, { progress: Math.min(100, Math.max(0, progress)) }, { new: true });
        if (!enrollment) {
            return res.status(404).json({ message: 'Enrollment not found' });
        }
        res.json({
            success: true,
            progress: enrollment.progress
        });
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to update progress' });
    }
});
// Admin: Get all enrollments for a course
router.get('/course/:courseId', requireAuth, async (req, res) => {
    try {
        const courseId = req.params.courseId;
        const enrollments = await Enrollment.find({ course: courseId })
            .populate('student', 'name email')
            .sort({ enrollmentDate: -1 });
        res.json(enrollments.map(e => ({
            id: e._id,
            student: {
                id: e.student._id,
                name: e.student.name,
                email: e.student.email
            },
            status: e.status,
            paymentStatus: e.paymentStatus,
            progress: e.progress,
            enrollmentDate: e.enrollmentDate
        })));
    }
    catch (e) {
        res.status(500).json({ message: e.message || 'Failed to get course enrollments' });
    }
});
export default router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5yb2xsbWVudHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVzL2Vucm9sbG1lbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFakMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFcEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFFeEIsd0NBQXdDO0FBQ3hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDaEYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUksR0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUM7UUFFekMsTUFBTSxVQUFVLEdBQUcsTUFBTSxVQUFVLENBQUMsT0FBTyxDQUFDO1lBQzFDLE9BQU8sRUFBRSxNQUFNO1lBQ2YsTUFBTSxFQUFFLFFBQVE7WUFDaEIsYUFBYSxFQUFFLFdBQVc7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLFVBQVUsRUFBRSxDQUFDLENBQUMsVUFBVTtZQUN4QixnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsTUFBTSxJQUFJLElBQUk7WUFDNUMsYUFBYSxFQUFFLFVBQVUsRUFBRSxhQUFhLElBQUksSUFBSTtTQUNqRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxDQUFNLEVBQUUsQ0FBQztRQUNoQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElB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Q0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHO1lBQ1QsT0FBTyxFQUFFO2dCQUNQLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUc7Z0JBQ2pCLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUk7Z0JBQ3BCLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUs7YUFDdkI7WUFDRCxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU07WUFDaEIsYUFBYSxFQUFFLENBQUMsQ0FBQyxhQUFhO1lBQzlCLFFBQVEsRUFBRSxDQUFDLENBQUMsUUFBUTtZQUNwQixjQUFjLEVBQUUsQ0FBQyxDQUFDLGNBQWM7U0FDakMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFBQyxPQUFPLENBQU0sRUFBRSxDQUFDO1FBQ2hCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksa0NBQWtDLEVBQUUsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB0eXBlIHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgRW5yb2xsbWVudCB9IGZyb20gJy4uL21vZGVscy9FbnJvbGxtZW50LnRzJztcclxuaW1wb3J0IHsgQ291cnNlIH0gZnJvbSAnLi4vbW9kZWxzL0NvdXJzZS50cyc7XHJcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9hdXRoLnRzJztcclxuXHJcbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xyXG5cclxuLy8gQ2hlY2sgaWYgdXNlciBpcyBlbnJvbGxlZCBpbiBhIGNvdXJzZVxyXG5yb3V0ZXIuZ2V0KCcvY2hlY2svOmNvdXJzZUlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgY291cnNlSWQgPSByZXEucGFyYW1zLmNvdXJzZUlkO1xyXG4gICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LnVzZXJJZDtcclxuXHJcbiAgICBjb25zdCBlbnJvbGxtZW50ID0gYXdhaXQgRW5yb2xsbWVudC5maW5kT25lKHtcclxuICAgICAgc3R1ZGVudDogdXNlcklkLFxyXG4gICAgICBjb3Vyc2U6IGNvdXJzZUlkLFxyXG4gICAgICBwYXltZW50U3RhdHVzOiAnY29tcGxldGVkJ1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmVzLmpzb24oe1xyXG4gICAgICBpc0Vucm9sbGVkOiAhIWVucm9sbG1lbnQsXHJcbiAgICAgIGVucm9sbG1lbnRTdGF0dXM6IGVucm9sbG1lbnQ/LnN0YXR1cyB8fCBudWxsLFxyXG4gICAgICBwYXltZW50U3RhdHVzOiBlbnJvbGxtZW50Py5wYXltZW50U3RhdHVzIHx8IG51bGxcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGU6IGFueSkge1xyXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiBlLm1lc3NhZ2UgfHwgJ0ZhaWxlZCB0byBjaGVjayBlbnJvbGxtZW50JyB9KTtcclxuICB9XHJcbn0pO1xyXG5cclxuLy8gQ3JlYXRlIGVucm9sbG1lbnQgd2l0aCBwYXltZW50IChzaW1wbGlmaWVkIHBheW1lbnQgcHJvY2Vzc2luZylcclxucm91dGVyLnBvc3QoJy8nLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGNvdXJzZUlkLCBwYXltZW50TWV0aG9kID0gJ2NyZWRpdF9jYXJkJyB9ID0gcmVxLmJvZHk7XHJcbiAgICBjb25zdCB1c2VySWQgPSAocmVxIGFzIGFueSkudXNlcj8udXNlcklkO1xyXG5cclxuICAgIC8vIENoZWNrIGlmIGNvdXJzZSBleGlzdHNcclxuICAgIGNvbnN0IGNvdXJzZSA9IGF3YWl0IENvdXJzZS5maW5kQnlJZChjb3Vyc2VJZCk7XHJcbiAgICBpZiAoIWNvdXJzZSkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnQ291cnNlIG5vdCBmb3VuZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhbHJlYWR5IGVucm9sbGVkXHJcbiAgICBjb25zdCBleGlzdGluZ0Vucm9sbG1lbnQgPSBhd2FpdCBFbnJvbGxtZW50LmZpbmRPbmUoe1xyXG4gICAgICBzdHVkZW50OiB1c2VySWQsXHJcbiAgICAgIGNvdXJzZTogY291cnNlSWRcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChleGlzdGluZ0Vucm9sbG1lbnQpIHtcclxuICAgICAgaWYgKGV4aXN0aW5nRW5yb2xsbWVudC5wYXltZW50U3RhdHVzID09PSAnY29tcGxldGVkJykge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdBbHJlYWR5IGVucm9sbGVkIGluIHRoaXMgY291cnNlJyB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBVcGRhdGUgZXhpc3RpbmcgZW5yb2xsbWVudFxyXG4gICAgICAgIGV4aXN0aW5nRW5yb2xsbWVudC5wYXltZW50U3RhdHVzID0gJ2NvbXBsZXRlZCc7XHJcbiAgICAgICAgZXhpc3RpbmdFbnJvbGxtZW50LnN0YXR1cyA9ICdhY3RpdmUnO1xyXG4gICAgICAgIGV4aXN0aW5nRW5yb2xsbWVudC5wYXltZW50SWQgPSBgUEFZLSR7RGF0ZS5ub3coKX1gO1xyXG4gICAgICAgIGF3YWl0IGV4aXN0aW5nRW5yb2xsbWVudC5zYXZlKCk7XHJcblxyXG4gICAgICAgIC8vIFVwZGF0ZSBjb3Vyc2UgZW5yb2xsbWVudCBjb3VudFxyXG4gICAgICAgIGNvdXJzZS5lbnJvbGxtZW50Q291bnQgKz0gMTtcclxuICAgICAgICBhd2FpdCBjb3Vyc2Uuc2F2ZSgpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xyXG4gICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgIGVucm9sbG1lbnRJZDogZXhpc3RpbmdFbnJvbGxtZW50Ll9pZCxcclxuICAgICAgICAgIG1lc3NhZ2U6ICdFbnJvbGxtZW50IHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5J1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUHJvY2VzcyBwYXltZW50IChzaW1wbGlmaWVkIC0gaW4gcmVhbCBhcHAsIGludGVncmF0ZSB3aXRoIFN0cmlwZS9QYXlQYWwpXHJcbiAgICBjb25zdCBwYXltZW50SWQgPSBgUEFZLSR7RGF0ZS5ub3coKX1gO1xyXG4gICAgY29uc3QgcGF5bWVudFN0YXR1cyA9ICdjb21wbGV0ZWQnOyAvLyBBc3N1bWUgcGF5bWVudCBzdWNjZWVkc1xyXG5cclxuICAgIC8vIENyZWF0ZSBuZXcgZW5yb2xsbWVudFxyXG4gICAgY29uc3QgZW5yb2xsbWVudCA9IGF3YWl0IEVucm9sbG1lbnQuY3JlYXRlKHtcclxuICAgICAgc3R1ZGVudDogdXNlcklkLFxyXG4gICAgICBjb3Vyc2U6IGNvdXJzZUlkLFxyXG4gICAgICBzdGF0dXM6ICdhY3RpdmUnLFxyXG4gICAgICBwYXltZW50U3RhdHVzOiBwYXltZW50U3RhdHVzLFxyXG4gICAgICBwYXltZW50SWQ6IHBheW1lbnRJZCxcclxuICAgICAgcHJvZ3Jlc3M6IDBcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFVwZGF0ZSBjb3Vyc2UgZW5yb2xsbWVudCBjb3VudFxyXG4gICAgY291cnNlLmVucm9sbG1lbnRDb3VudCArPSAxO1xyXG4gICAgYXdhaXQgY291cnNlLnNhdmUoKTtcclxuXHJcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGVucm9sbG1lbnRJZDogZW5yb2xsbWVudC5faWQsXHJcbiAgICAgIG1lc3NhZ2U6ICdFbnJvbGxtZW50IHN1Y2Nlc3NmdWwnXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gY3JlYXRlIGVucm9sbG1lbnQnIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBHZXQgdXNlciBlbnJvbGxtZW50c1xyXG5yb3V0ZXIuZ2V0KCcvJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LnVzZXJJZDtcclxuXHJcbiAgICBjb25zdCBlbnJvbGxtZW50cyA9IGF3YWl0IEVucm9sbG1lbnQuZmluZCh7IHN0dWRlbnQ6IHVzZXJJZCB9KVxyXG4gICAgICAucG9wdWxhdGUoJ2NvdXJzZScsICd0aXRsZSBkZXNjcmlwdGlvbiBiYW5uZXJJbWFnZSBwcmljZSBjYXRlZ29yeScpXHJcbiAgICAgIC5zb3J0KHsgZW5yb2xsbWVudERhdGU6IC0xIH0pO1xyXG5cclxuICAgIHJlcy5qc29uKGVucm9sbG1lbnRzLm1hcChlID0+ICh7XHJcbiAgICAgIGlkOiBlLl9pZCxcclxuICAgICAgY291cnNlOiB7XHJcbiAgICAgICAgaWQ6IGUuY291cnNlLl9pZCxcclxuICAgICAgICB0aXRsZTogZS5jb3Vyc2UudGl0bGUsXHJcbiAgICAgICAgZGVzY3JpcHRpb246IGUuY291cnNlLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgIGJhbm5lckltYWdlOiBlLmNvdXJzZS5iYW5uZXJJbWFnZSxcclxuICAgICAgICBwcmljZTogZS5jb3Vyc2UucHJpY2UsXHJcbiAgICAgICAgY2F0ZWdvcnk6IGUuY291cnNlLmNhdGVnb3J5XHJcbiAgICAgIH0sXHJcbiAgICAgIHN0YXR1czogZS5zdGF0dXMsXHJcbiAgICAgIHBheW1lbnRTdGF0dXM6IGUucGF5bWVudFN0YXR1cyxcclxuICAgICAgcHJvZ3Jlc3M6IGUucHJvZ3Jlc3MsXHJcbiAgICAgIGVucm9sbG1lbnREYXRlOiBlLmVucm9sbG1lbnREYXRlXHJcbiAgICB9KSkpO1xyXG4gIH0gY2F0Y2ggKGU6IGFueSkge1xyXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiBlLm1lc3NhZ2UgfHwgJ0ZhaWxlZCB0byBnZXQgZW5yb2xsbWVudHMnIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBHZXQgZW5yb2xsbWVudCBieSBJRFxyXG5yb3V0ZXIuZ2V0KCcvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgZW5yb2xsbWVudElkID0gcmVxLnBhcmFtcy5pZDtcclxuICAgIGNvbnN0IHVzZXJJZCA9IChyZXEgYXMgYW55KS51c2VyPy51c2VySWQ7XHJcblxyXG4gICAgY29uc3QgZW5yb2xsbWVudCA9IGF3YWl0IEVucm9sbG1lbnQuZmluZE9uZSh7XHJcbiAgICAgIF9pZDogZW5yb2xsbWVudElkLFxyXG4gICAgICBzdHVkZW50OiB1c2VySWRcclxuICAgIH0pLnBvcHVsYXRlKCdjb3Vyc2UnLCAndGl0bGUgZGVzY3JpcHRpb24gYmFubmVySW1hZ2UgcHJpY2UgY2F0ZWdvcnknKTtcclxuXHJcbiAgICBpZiAoIWVucm9sbG1lbnQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0Vucm9sbG1lbnQgbm90IGZvdW5kJyB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXMuanNvbih7XHJcbiAgICAgIGlkOiBlbnJvbGxtZW50Ll9pZCxcclxuICAgICAgY291cnNlOiB7XHJcbiAgICAgICAgaWQ6IGVucm9sbG1lbnQuY291cnNlLl9pZCxcclxuICAgICAgICB0aXRsZTogZW5yb2xsbWVudC5jb3Vyc2UudGl0bGUsXHJcbiAgICAgICAgZGVzY3JpcHRpb246IGVucm9sbG1lbnQuY291cnNlLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgIGJhbm5lckltYWdlOiBlbnJvbGxtZW50LmNvdXJzZS5iYW5uZXJJbWFnZSxcclxuICAgICAgICBwcmljZTogZW5yb2xsbWVudC5jb3Vyc2UucHJpY2UsXHJcbiAgICAgICAgY2F0ZWdvcnk6IGVucm9sbG1lbnQuY291cnNlLmNhdGVnb3J5XHJcbiAgICAgIH0sXHJcbiAgICAgIHN0YXR1czogZW5yb2xsbWVudC5zdGF0dXMsXHJcbiAgICAgIHBheW1lbnRTdGF0dXM6IGVucm9sbG1lbnQucGF5bWVudFN0YXR1cyxcclxuICAgICAgcHJvZ3Jlc3M6IGVucm9sbG1lbnQucHJvZ3Jlc3MsXHJcbiAgICAgIGVucm9sbG1lbnREYXRlOiBlbnJvbGxtZW50LmVucm9sbG1lbnREYXRlXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gZ2V0IGVucm9sbG1lbnQnIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBVcGRhdGUgZW5yb2xsbWVudCBwcm9ncmVzc1xyXG5yb3V0ZXIucHV0KCcvOmlkL3Byb2dyZXNzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgZW5yb2xsbWVudElkID0gcmVxLnBhcmFtcy5pZDtcclxuICAgIGNvbnN0IHsgcHJvZ3Jlc3MgfSA9IHJlcS5ib2R5O1xyXG4gICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LnVzZXJJZDtcclxuXHJcbiAgICBjb25zdCBlbnJvbGxtZW50ID0gYXdhaXQgRW5yb2xsbWVudC5maW5kT25lQW5kVXBkYXRlKFxyXG4gICAgICB7XHJcbiAgICAgICAgX2lkOiBlbnJvbGxtZW50SWQsXHJcbiAgICAgICAgc3R1ZGVudDogdXNlcklkXHJcbiAgICAgIH0sXHJcbiAgICAgIHsgcHJvZ3Jlc3M6IE1hdGgubWluKDEwMCwgTWF0aC5tYXgoMCwgcHJvZ3Jlc3MpKSB9LFxyXG4gICAgICB7IG5ldzogdHJ1ZSB9XHJcbiAgICApO1xyXG5cclxuICAgIGlmICghZW5yb2xsbWVudCkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnRW5yb2xsbWVudCBub3QgZm91bmQnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlcy5qc29uKHtcclxuICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgcHJvZ3Jlc3M6IGVucm9sbG1lbnQucHJvZ3Jlc3NcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGU6IGFueSkge1xyXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiBlLm1lc3NhZ2UgfHwgJ0ZhaWxlZCB0byB1cGRhdGUgcHJvZ3Jlc3MnIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vLyBBZG1pbjogR2V0IGFsbCBlbnJvbGxtZW50cyBmb3IgYSBjb3Vyc2Vcclxucm91dGVyLmdldCgnL2NvdXJzZS86Y291cnNlSWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb3Vyc2VJZCA9IHJlcS5wYXJhbXMuY291cnNlSWQ7XHJcblxyXG4gICAgY29uc3QgZW5yb2xsbWVudHMgPSBhd2FpdCBFbnJvbGxtZW50LmZpbmQoeyBjb3Vyc2U6IGNvdXJzZUlkIH0pXHJcbiAgICAgIC5wb3B1bGF0ZSgnc3R1ZGVudCcsICduYW1lIGVtYWlsJylcclxuICAgICAgLnNvcnQoeyBlbnJvbGxtZW50RGF0ZTogLTEgfSk7XHJcblxyXG4gICAgcmVzLmpzb24oZW5yb2xsbWVudHMubWFwKGUgPT4gKHtcclxuICAgICAgaWQ6IGUuX2lkLFxyXG4gICAgICBzdHVkZW50OiB7XHJcbiAgICAgICAgaWQ6IGUuc3R1ZGVudC5faWQsXHJcbiAgICAgICAgbmFtZTogZS5zdHVkZW50Lm5hbWUsXHJcbiAgICAgICAgZW1haWw6IGUuc3R1ZGVudC5lbWFpbFxyXG4gICAgICB9LFxyXG4gICAgICBzdGF0dXM6IGUuc3RhdHVzLFxyXG4gICAgICBwYXltZW50U3RhdHVzOiBlLnBheW1lbnRTdGF0dXMsXHJcbiAgICAgIHByb2dyZXNzOiBlLnByb2dyZXNzLFxyXG4gICAgICBlbnJvbGxtZW50RGF0ZTogZS5lbnJvbGxtZW50RGF0ZVxyXG4gICAgfSkpKTtcclxuICB9IGNhdGNoIChlOiBhbnkpIHtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZS5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gZ2V0IGNvdXJzZSBlbnJvbGxtZW50cycgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcclxuIl19